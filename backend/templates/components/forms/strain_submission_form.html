<section class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-9 col-xl-7">
      <div class="card">
        <div class="card-body p-4 p-md-5">
          <div class="card-body p-4 p-md-5">
            <h3 class="mb-4 pb-2">Submissions Form</h3>
            <form action="#" id="strainSubmissionForm">
              <div class="row">
                <div class="col-12 mb-4">
                  <h6 class="mb-2 pb-1">Product Type: </h6>
                  <div data-mdb-input-init class="form-check form-check-inline">
                    <input 
                      class="form-check-input"
                      type="radio"
                      name="inlineRadioOptions"
                      id="flowerSubmission"
                      value="flowerSubmission"
                    />
                    <label class="form-check-label" for="Flower">Flower</label>
                  </div>
                  <div data-mdb-input-init class="form-check form-check-inline">
                    <input 
                      class="form-check-input"
                      type="radio"
                      name="inlineRadioOptions"
                      id="concentrateSubmission"
                      value="concentrateSubmission"
                    />
                    <label class="form-check-label" for="Concentrate">Concentrate</label>
                  </div>
                  <div data-mdb-input-init class="form-check form-check-inline">
                    <input 
                      class="form-check-input"
                      type="radio"
                      name="inlineRadioOptions"
                      id="pre_rollSubmission"
                      value="pre_rollSubmission"
                    />
                    <label class="form-check-label" for="Pre-Roll">Pre-Roll</label>
                  </div>
                  <!--
                  <div data-mdb-input-init class="form-check form-check-inline">
                    <input 
                      class="form-check-input"
                      type="radio"
                      name="inlineRadioOptions"
                      id="edibleSubmission"
                      value="edibleSubmission"
                    />
                    <label class="form-check-label" for="otherGender">Edible</label>
                  </div>
                  -->
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-4">
                  <div data-mdb-input-init class="form-outline">
                    <input type="text" id="strainSubmission" class="form-control" />
                    <label class="form-label" for="strainSubmission">Strain Name</label>
                  </div>
                </div>
                <div class="col-md-6 mb-4">
                  <div data-mdb-input-init class="form-outline">
                    <input type="text" id="cultivatorSubmission" class="form-control" />
                    <label class="form-label" for="cultivatorSubmission">Cultivator</label>
                  </div>
                </div>
              </div>
              <div class="col-12 mb-3 pb-2">
                <select class="form-outline w-100" data-mdb-select-init data-mdb-placeholder="Select One or Multiple Terpenes" multiple>
                  <option value="alpha_bergamotene">Alpha Bergamotene</option>
                  <option value="alpha_beta_cis_ocimene">Alpha Beta Cis Ocimene</option>
                  <option value="alpha_beta_pinene">Alpha Beta Pinene</option>
                  <option value="alpha_beta_thujene">Alpha Beta Thujene</option>
                  <option value="alpha_bisabolene">Alpha Bisabolene</option>
                  <option value="alpha_bisabolol">Alpha Bisabolol</option>
                  <option value="alpha_cedrene">Alpha Cedrene</option>
                  <option value="alpha_fenchene">Alpha Fenchene</option>
                  <option value="alpha_humulene">Alpha Humulene</option>
                  <option value="alpha_humulene_epoxide_i">Alpha Humulene Epoxide I</option>
                  <option value="alpha_phellandrene">Alpha Phellandrene</option>
                  <option value="alpha_pinene">Alpha Pinene</option>
                  <option value="alpha_terpinene">Alpha Terpinene</option>
                  <option value="alpha_terpineol">Alpha Terpineol</option>
                  <option value="alpha_terpinolene">Alpha Terpinolene</option>
                  <option value="alpha_thujene">Alpha Thujene</option>
                  <option value="alpha_zingiberene">Alpha Zingiberene</option>
                  <option value="beta_asarone">Beta Asarone</option>
                  <option value="beta_bisabolene">Beta Bisabolene</option>
                  <option value="beta_caryophyllene_oxide">Beta Caryophyllene Oxide</option>
                  <option value="beta_farnesene">Beta Farnesene</option>
                  <option value="beta_myrcene">Beta Myrcene</option>
                  <option value="beta_ocimene">Beta Ocimene</option>
                  <option value="beta_pinene">Beta Pinene</option>
                  <option value="beta_selinene">Beta Selinene</option>
                  <option value="beta_terpinene">Beta Terpinene</option>
                  <option value="camphene">Camphene</option>
                  <option value="caryophyllene">Caryophyllene</option>
                  <option value="caryophyllene_oxide">Caryophyllene Oxide</option>
                  <option value="cis_nerolidol">Cis Nerolidol</option>
                  <option value="cis_beta_ocimene">Cis Beta Ocimene</option>
                  <option value="delta_3_carene">Delta 3 Carene</option>
                  <option value="delta_limonene">Delta Limonene</option>
                  <option value="eucalyptol">Eucalyptol</option>
                  <option value="gamma_terpinene">Gamma Terpinene</option>
                  <option value="geraniol">Geraniol</option>
                  <option value="guaiol">Guaiol</option>
                  <option value="isoborneol">Isoborneol</option>
                  <option value="isopulegol">Isopulegol</option>
                  <option value="limonene">Limonene</option>
                  <option value="linalool">Linalool</option>
                  <option value="myrcene">Myrcene</option>
                  <option value="nerolidol">Nerolidol</option>
                  <option value="ocimene">Ocimene</option>
                  <option value="p_cymene">P Cymene</option>
                  <option value="para_cymene">Para Cymene</option>
                  <option value="phellandrene">Phellandrene</option>
                  <option value="terpineol">Terpineol</option>
                  <option value="terpinolene">Terpinolene</option>
                  <option value="trans_nerolidol">Trans Nerolidol</option>
                  <option value="trans_ocimene">Trans Ocimene</option>
                  <option value="y_terpinene">Y Terpinene</option>
                  <option value="beta_caryophyllene">Beta Caryophyllene</option>
                </select>
              </div>
              <div class="row">
                <div class="col-12">
                  <div data-mdb-input-init class="form-outline mb-4">
                    <textarea class="form-control" id="strainDescription" rows="4"></textarea>
                    <label class="form-label" for="strainDescription">Description</label>
                  </div>
                </div>
                <div class="col-12 mb-3">
                  <div class="form-outline" data-mdb-input-init>
                    <textarea class="form-control" id="effectsSubmission" rows="4"></textarea>
                    <label class="form-label" for="effectsSubmission">Effects</label>
                  </div>
                </div>
                <div class="input-group text-center mx-auto align-items-center py-3">
                  <input type="text" id="terpeneInput" class="form-control form-outline-light" placeholder="Enter terpenes" aria-label="Enter Terpenes"/>
                  <button type="button" id="addTerpene" class="form-control form-outline btn-dark btn-outline-info btn-lg" data-mdb-ripple-init data-mdb-ripple-color="secondary">Add Terp</button>
                </div>
              </div>
              <div class="col-12 align-items-center text-center mx-auto py-5 form-control form-outline align-conent-center">
                <div id="terpeneChipsContainer" class="chips-container row my-2 mx-auto align-items-center"></div>
              </div>
              <div class="row pt-4">
                <div class="col-12 mb-3 mx-auto me-3 pt-2">
                  <div data-mdb-input-init class="form-outline">
                    <input type="email" id="emailAddress" class="form-control" />
                    <label class="form-label" for="emailAddress">Your Email Address</label>
                  </div>
                </div>
              </div>
              <div class="col-12 mx-auto">
                <div class="mt-4 pe-0">
                  <button data-mdb-ripple-init class="btn btn-info btn-lg w-100 text-dark" type="submit" data-mdb-ripple-color="info"/>Submit Strain</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="modal fade" id="missingInfoModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true" data-bs-backdrop="false">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Missing Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- The missing fields information will be inserted here -->
      </div>
      <div class="modal-footer">
        <div class="col-12 mx-auto">
          <button type="button" class="btn btn-lg btn-dark w-100" data-bs-dismiss="modal" aria-label="Close">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% block scripts %}
<script>

function getNewlyCreatedStrain(strain, cultivator, cultivar_email) {
    const productTypeElements = document.getElementsByName("inlineRadioOptions");
    for (const ptElement of productTypeElements) {
        if (ptElement.checked) {
            let reviewUrl;
            switch(ptElement.value) {
                case "flowerSubmission":
                    reviewUrl = `/get-review?strain_selected=${strain}&cultivator_selected=${cultivator}&cultivar_email=${cultivar_email}`;
                    break;
                case "concentrateSubmission":
                    reviewUrl = `/concentrate-get-review?strain_selected=${strain}&cultivator_selected=${cultivator}&cultivar_email=${cultivar_email}`;
                    break;
                case "pre_rollSubmission":
                    reviewUrl = `/pre-roll-get-review?strain=${strain}&cultivator=${cultivator}&cultivar_email=${cultivar_email}`;
                    break;
                default:
                    console.error("Unknown product type:", ptElement.value);
                    return;
            }
            window.location.href = reviewUrl;
            break;
        }
    }
}
async function submitStrainForm(event) {
    event.preventDefault();
    const form = document.getElementById("strainSubmissionForm");
    const modalBody = document.querySelector('#missingInfoModal .modal-body');
    const submitButton = form.querySelector('button[type="submit"]');

    const strainValue = document.getElementById("strainSubmission").value;
    const cultivatorValue = document.getElementById("cultivatorSubmission").value;
    const emailAddressValue = document.getElementById("emailAddress").value.toLowerCase();
    const descriptionValue = document.getElementById("strainDescription").value;
    const effectsValue = document.getElementById("effectsSubmission").value;

    // Determine the selected product type
    const productTypeElements = document.getElementsByName("inlineRadioOptions");
    let productTypeValue = '';
    for (const ptElement of productTypeElements) {
        if (ptElement.checked) {
            productTypeValue = ptElement.value;
            break;
        }
    }
    let missingFields = [];

    // Check each field in the form
    if (!productTypeValue) missingFields.push('Product Type');
    if (!strainValue) missingFields.push('Strain Name');
    if (!cultivatorValue) missingFields.push('Cultivator');
    if (!descriptionValue) missingFields.push('Description');
    if (!effectsValue) missingFields.push('Effects');
    if (!emailAddressValue) missingFields.push('Email Address');

    if (missingFields.length > 0) {
        // Update modal body with missing fields
        modalBody.innerHTML = `<p>Please complete the following fields:</p><ul>${missingFields.map(field => `<li>${field}</li>`).join('')}</ul>`;
        
        // Trigger the modal
        const missingInfoModal = new bootstrap.Modal(document.getElementById('missingInfoModal'));
        missingInfoModal.show();
    } else {
      const cleanCultivatorString = window.supabaseClient.sanitizeInputString(cultivatorValue);
      const cleanStrainString = window.supabaseClient.sanitizeInputString(strainValue);
      // Prepare the FormData object
      const formData = new FormData();
      
      formData.append('strain', cleanStrainString);
      formData.append('cultivator', cleanCultivatorString);
      formData.append('cultivar_email', emailAddressValue);
      formData.append('description', descriptionValue || 'Coming Soon');
      formData.append('effects', effectsValue || 'Coming Soon');
      formData.append('product_type', productTypeValue);
      
      // Submit the form data
      const root = window.location.origin;
      const url = new URL('/submit/submit_strain/', root);
  
      const response = await fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
              'Accept': 'application/json',
          }
      });
  
      if (response.ok) {
          const responseData = await response.json();
          getNewlyCreatedStrain(responseData.submission_strain, responseData.submission_cultivator, responseData.cultivar_email);
          return;
      } else {
          console.error("Form submission failed:", response.status, response.statusText);
          alert('The submission failed, check your inputs and try again.');
          return;
      }
    }
}
document.addEventListener('DOMContentLoaded', (event) => {
    document.getElementById('addTerpene').addEventListener('click', function() {
        createChip();
    });
    
    document.getElementById('terpeneInput').addEventListener('keypress', function(event) {
        if (event.key === "Enter") {
            event.preventDefault(); // Prevent the form from being submitted
            createChip();
        }
    });
    
    const terpenes = []; // Array to hold the values for form submission
    
    function createChip() {
        const input = document.getElementById('terpeneInput');
        const value = input.value.trim();
    
        if (value) {
          // Create the chip element
          const chipContainer = document.createElement('div');
          chipContainer.className = 'col-6';
  
          // Create the chip element
          const chip = document.createElement('div');
          chip.className = 'chip chip-outline btn-outline-dark';
          chip.setAttribute('data-mdb-chip-init', '');
          chip.setAttribute('data-mdb-ripple-color', 'dark');
          chip.textContent = value;
  
          // Add close icon
          const closeIcon = document.createElement('i');
          closeIcon.className = 'close fas fa-times';
          closeIcon.addEventListener('click', function() {
            chipContainer.remove(); // Remove the entire column on close
            const index = terpenes.indexOf(value);
            if (index > -1) {
              terpenes.splice(index, 1); // Remove value from array
            }
          });
  
          chip.appendChild(closeIcon);
          chipContainer.appendChild(chip);
  
          // Append the column to the chips container
          document.getElementById('terpeneChipsContainer').appendChild(chipContainer);
  
          // Add the value to the array for form submission
          terpenes.push(value);
  
          // Clear the input
          input.value = '';
        }
    }
    const form = document.getElementById("strainSubmissionForm");
    const modalBody = document.querySelector('#missingInfoModal .modal-body');
    form.addEventListener('submit', async function(event) {
      submitStrainForm(event);
    });
});
</script>
{% endblock %}
