<div class="container">
  <div class="row">
    <div class="col-lg-8 col-md-10 mx-auto">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-center">Get Cultivar Reviews</h5>
          <form method="POST" action="/get-review" id="review-form">

            <!-- Product Type Select Box -->
            <div class="mb-3">
              <label for="product_type_selected" class="form-label">Product Type</label>
              <select class="form-select" id="product_type_selected" name="product_type_selected">
                <!-- Options will be populated here -->
              </select>
            </div>

            <!-- Cultivator Select Box -->
            <div class="mb-3">
              <label for="cultivator_selected" class="form-label">Cultivator</label>
              <select class="form-select" id="cultivator_selected" name="cultivator_selected">
                <!-- Options will be populated here -->
              </select>
            </div>

            <!-- Strain Select Box -->
            <div class="mb-3">
              <label for="strain_selected" class="form-label">Strain</label>
              <select class="form-select" id="strain_selected" name="strain_selected">
                <!-- Options will be populated here -->
              </select>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2">
              <button class="btn btn-info" type="submit">Submit</button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>


{% block scripts %}
  <script>
    window.addEventListener('DOMContentLoaded', function() {
    
      var typeSwitch = document.getElementById('typeSwitch');
      var form = document.getElementById('review-form');
      var typeLabel = document.getElementById('typeLabel');
      var strainSelect = document.getElementById('strain_selected');
      var cultivatorSelect = document.getElementById('cultivator_selected');
      var submitButton = document.getElementById('submit');
      
      function getRouteBase() {
        return typeSwitch.checked ? '/concentrate-' : '/';
      }
      
      function getFormAction() {
        return typeSwitch.checked ? '/concentrate-get-review' : '/get-review';
      }
      
      typeLabel.textContent = typeSwitch.checked ? 'Concentrates' : 'Flower';
      
      typeSwitch.addEventListener('change', function() {
        typeLabel.textContent = typeSwitch.checked ? 'Concentrates' : 'Flower';
        strainSelect.innerHTML = ''; 
        cultivatorSelect.innerHTML = '';
        fetchCultivatorsAndStrains(); 
        form.action = getFormAction();
      });
  
      function updateButtonState() {
        submitButton.disabled = !(strainSelect.value && cultivatorSelect.value);
      }
  
      function fetchCultivatorsAndStrains() {
        var initialLoad = !localStorage.getItem('selectedCultivator');
        var routeBase = getRouteBase();
  
        fetch(routeBase + 'get-all-cultivators')
          .then(response => response.json())
          .then(data => {
            cultivatorSelect.innerHTML = '';
            var selectedCultivator = initialLoad ? data[0] : localStorage.getItem('selectedCultivator');
            data.forEach(function(cultivator) {
              var option = document.createElement('option');
              option.text = cultivator;
              option.value = cultivator;
              if (cultivator === selectedCultivator) {
                option.selected = true;
              }
              cultivatorSelect.add(option);
            });
  
            var event = new Event('change');
            cultivatorSelect.dispatchEvent(event);
          });
      }
  
      fetchCultivatorsAndStrains();
  
      cultivatorSelect.addEventListener('change', function(e) {
        var cultivatorSelected = e.target.value;
        localStorage.setItem('selectedCultivator', cultivatorSelected);
        
        fetch(getRouteBase() + 'get-strains-for-cultivator?cultivator_selected=' + cultivatorSelected)
          .then(response => response.json())
          .then(data => {
            strainSelect.innerHTML = '';
            var selectedStrain = localStorage.getItem('selectedStrain') || data[0];
            data.forEach(function(strain) {
              var option = document.createElement('option');
              option.text = strain;
              option.value = strain;
              if (strain === selectedStrain) {
                option.selected = true;
              }
              strainSelect.add(option);
            });
            updateButtonState();
          });
      });
  
      strainSelect.addEventListener('change', function(e) {
        localStorage.setItem('selectedStrain', e.target.value);
        updateButtonState();
      });
  
      cultivatorSelect.addEventListener('change', updateButtonState);
      strainSelect.addEventListener('change', updateButtonState);
      
      updateButtonState();
    });
  </script>
{% endblock %}
