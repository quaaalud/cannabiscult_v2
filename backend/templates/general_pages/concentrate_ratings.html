{% extends "shared/base.html" %}

{% block title %} 
  <title>Cultivar Review {{ strain }} - Cannabis Cult</title>
{% endblock %} 

{% block head %}
<meta 
  content="Cannabis Cult {{ strain }} Cultivar Rating Page." 
  name="description"
/>
<meta 
  name="keywords"
  content="Cannabis Cult, Cultivar Review, Cannabis Ratings, Cannabis Review, Weed Reviews, Cannabis Near Me, Dispensary Reviews, Edible Ratings, Edible Reviews"
/>
<meta 
  property="og:image" 
  content="{% if url_path %}{{ url_path }}{% else %}https://tahksrvuvfznfytctdsl.supabase.co/storage/v1/object/sign/cannabiscult/reviews/Connoisseur%20Pack/CP%20Rosin?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJjYW5uYWJpc2N1bHQvcmV2aWV3cy9Db25ub2lzc2V1ciBQYWNrL0NQIFJvc2luIiwiaWF0IjoxNzAxMzEzNjc0LCJleHAiOjE3MzI4NDk2NzR9.J7m_xfZWyMGi8v6XSoMVm68e3RPU5UdGPPPXaPNtQ2I&t=2023-11-30T03%3A07%3A54.251Z{% endif %}"
  alt="Cannabis Cult {{ strain }} Cultivar Connoisseur Rating Card"
/>
<meta 
  property="og:description" 
  content="Cannabis Cult {{ strain }} Cultivar Connoisseur Rating Page." 
/>
<meta 
  property="og:title" 
  content="Cannabis Cult {% if strain %}{{ strain }} {% endif %}Cultivar Connoisseur Rating"
/>
<meta 
  name="twitter:card" 
  content="summary_large_image"
/>
<meta 
  property="twitter:url" 
  content="https://cannabiscult.co"
/>
<meta 
  property="twitter:site" 
  content="@cannabiscult"
/>
<meta 
  property="twitter:title" 
  content="Cannabis Cult Cultivar {% if strain %}{{ strain }} {% endif %}Connoisseur Rating." 
/>
<meta 
  property="twitter:description" 
  content="{{ strain }} Cultivar Review Page on CannabisCult.co" 
/>
<meta 
  property="twitter:image" 
  content="{{ url_path }}"
/>
<meta 
  property="twitter:image:alt"
  content="Cannabis Cult Cultivar Review Card for {{ strain }} Concentrate"
/>
<link 
  rel="canonical" 
  href="https://cannabiscult.co/connoisseur-concentrates{% if strain %}/get-concentrate?{{ strain }}{% endif %}"
/>
{% endblock %}

{% block header %}
{% endblock %}

{% block content %}
<main class="container pt-5">
    <section draggable="false" class="container pt-3" data-v-271253ee="">
      <section class="mb-10">
        <div class="container mb-5 mx-auto">
          <div class="row mx-auto mb-0 mb-lg-5 justify-content-between">
            <div class="col-12 text-center pb-5 my-auto">
              <h1 class="fw-bold">Cultivar Concentrate Ratings</h1>
            </div>
          </div>
        </div>
        <div class="row gx-lg-5 align-items-start d-flex justify-content-between mx-auto">
          <div class="col-12 col-lg-6 mb-5 mb-lg-0 pt-0 pb-sm-0 pb-md-5 py-lg-0 mx-auto">
            <div class="container pt-xl-3">
              {% include "components/voting_cards/concentrate_card.html" %}
            </div>
          </div>
          <div class="col-12 col-lg-6 mb-4 mb-lg-0 pt-md-5 mx-auto">
            <div class="d-flex flex-column justify-content-between pt-md-2">
              <div class="d-flex align-items-start mb-5">
                <div class="flex-shrink-0">
                  <div class="p-3 rounded-4 shadow-2-strong" style="background-color: hsl(231, 52.6%, 20%)">
                    <i class="fas fa-comments fa-lg text-white fa-fw" aria-controls="#picker-editor"></i>
                  </div>
                </div>
                <div class="flex-grow-1 ms-4">
                  <p class="fw-bold mb-1">Description</p>
                  <p id="description_text" class="text-muted">
                    {% if is_mystery %}We cannot tell you about the mystery strains.{% elif description_text %}{{ description_text }}{% else %}Coming Soon{% endif %}
                  </p>
                </div>
              </div>
              <div class="d-flex align-items-start mb-5">
                <div class="flex-shrink-0">
                  <div class="p-3 rounded-4 shadow-2-strong" style="background-color: hsl(231, 52.6%, 20%)">
                    <i class="fa-solid fa-user-gear fa-lg text-white fa-fw" aria-controls="#picker-editor"></i>
                  </div>
                </div>
                <div class="flex-grow-1 ms-4">
                  <p class="fw-bold mb-1">Effects<br></p>
                  <p id="effects_text" class="text-muted">
                    {% if is_mystery %}But be sure to submit your ratings.{% elif effects %}{{ effects }}{% else %}Coming Soon{% endif %}
                  </p>
                </div>
              </div>
              <div class="d-flex align-items-start mb-5">
                <div class="flex-shrink-0">
                  <div class="p-3 rounded-4 shadow-2-strong" style="background-color: hsl(231, 52.6%, 20%)">
                    <i class="fas fa-timeline fa-lg text-white fa-fw" aria-controls="#picker-editor"></i>
                  </div>
                </div>
                <div class="flex-grow-1 ms-4">
                  <p class="fw-bold mb-1">Lineage</p>
                  <p id="lineage-text" class="text-muted">
                    {% if is_mystery %}So our cultivators know what you think.{% elif lineage %}{{ lineage }}{% else %}Coming Soon{% endif %}
                  </p>
                </div>
              </div>
              <div class="d-flex align-items-start mb-5">
                <div class="flex-shrink-0">
                  <div class="p-3 rounded-4 shadow-2-strong" style="background-color: hsl(231, 52.6%, 20%)">
                    <i class="fas fa-chart-pie fa-lg text-white fa-fw" aria-controls="#picker-editor"></i>
                  </div>
                </div>
                <div class="flex-grow-1 ms-4">
                  <p class="fw-bold mb-1">Terpenes</p>
                  <div id="terpene_text" class="text-muted mb-0">
                    {% if is_mystery %}
                      <p>And you will see all the results soon!</p>
                    {% else %}
                      <canvas id="terpeneChart"></canvas>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <section draggable="false" class="container" data-v-271253ee="">
      <section class="mb-10 text-center">
        <div class="row gx-lg-5">
          <div class="col-md-4 mb-4">
            <h2 id="flavor_rating_value" class="fw-bold display-5 text-info mb-3">
              {% if flavor_rating %}
                    {{ flavor_rating }}
                {% else %}
                    ?
                {% endif %}
            </h2>
            <h5 class="text-muted mb-3">Flavor</h5>
          </div>
          <div class="col-md-4 mb-4">
            <h2 id="overall_rating_value" class="fw-bold display-5 text-info mb-3">
              {% if overall_rating %}
                    {{ overall_rating }}
                {% else %}
                    ?
                {% endif %}
            </h2>
            <h5 class="text-muted mb-3">Overall</h5>
          </div>
          <div class="col-md-4 mb-4">
            <h2 id="effects_rating_value" class="fw-bold display-5 text-info mb-3">
              {% if effects_rating %}
                    {{ effects_rating }}
                {% else %}
                    ?
                {% endif %}
            </h2>
            <h5 class="text-muted mb-3">Effects</h5>
          </div>
        </div>
      </section>
    </section>

    <section draggable="false" class="container navy-color-parent" data-v-271253ee="">
      <section class="mb-10 text-center">
        <div class="row">
          <div class="col-lg-3 col-md-6 mb-5 mb-md-5 mb-lg-0 position-relative">
            <i class="fas fa-eye fa-3x  mb-4" aria-controls="#picker-editor"></i>
            <h5 id="color_rating_value" class="text-info fw-bold mb-3">
              -
            </h5>
            <h6 class="fw-normal mb-0">Color<br></h6>
            <hr class="divider-vertical d-none d-md-block">
          </div>
          <div class="col-lg-3 col-md-6 mb-5 mb-md-5 mb-lg-0 position-relative">
            <i class="fas fa-cannabis fa-3x  mb-4" aria-controls="#picker-editor"></i>
            <h5 id="smell_rating_value" class="text-info fw-bold mb-3">
              -
            </h5>
            <h6 class="fw-normal mb-0">Aroma</h6>
            <hr class="divider-vertical d-none d-lg-block">
          </div>
          <div class="col-lg-3 col-md-6 mb-5 mb-md-0 position-relative">
            <i class="fas fa-fill-drip fa-3x  mb-4" aria-controls="#picker-editor"></i>
            <h5 id="consistency_rating_value" class="text-info fw-bold mb-3">
              -
            </h5>
            <h6 class="fw-normal mb-0">Consistency</h6>
            <hr class="divider-vertical d-none d-md-block">
          </div>
          <div class="col-lg-3 col-md-6 mb-5 mb-md-0 position-relative">
            <i class="fas fa-arrow-trend-up fa-3x  mb-4" aria-controls="#picker-editor"></i>
            <h5 id="harshness_rating_value" class="text-info fw-bold mb-3">
              -
            </h5>
            <h6 class="fw-normal mb-0">Smoothness</h6>
          </div>
        </div>
      </section>
    </section>
  </div>
  <div class="text-center">
    <div class="container-fluid text-center pb-5">
      <a href="/">
        <img src="{{ url_for('static', path='images/small_black_cc_logo.png') }}">
      </a>
    </div>
  </div>
  <section class="py-4 container" id="topRatedStrains">
    {% include "components/top_rated_flower.html" %}
  </section>
  <div class="container align-items-center justify-items-center pt-5">
    {% include "components/homepage_elements/homepage_features.html" %}
  </div>
  <div class="container py-5">
    <div class="row mx-auto">
      <div class="col-12 col-lg-9 mx-auto">
        {% include "components/flower_review_selector.html" %}
      </div>
    </div>
  </div>
  <div class="container py-5">
    <div class="row mx-auto">
      <div class="col-auto mx-auto">
        <img class="img-fluid" src="https://tahksrvuvfznfytctdsl.supabase.co/storage/v1/object/sign/cannabiscult/card_assets/Cult%20Classic%20%20Cultivar%20Emblem.webp?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJjYW5uYWJpc2N1bHQvY2FyZF9hc3NldHMvQ3VsdCBDbGFzc2ljICBDdWx0aXZhciBFbWJsZW0ud2VicCIsImlhdCI6MTcwNDI0NzM4NywiZXhwIjoxNzM1NzgzMzg3fQ.xqhIiGk-3ZNcW45AtAdi7kFMzltAdusrdUf1U0o826E&t=2024-01-03T02%3A03%3A07.801Z"/>
      </div>
    </div>
  </div>
</main>
<style> 
  hr.divider-vertical { 
    position: absolute; 
    right: 0; 
    top: 0; 
    width: 1px; 
    background-image: linear-gradient( 180deg, transparent, hsl(0, 0%, 40%), transparent ); 
    background-color: transparent; 
    height: 100%; 
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async function() {
    await fetchAndUpdatConcentrateDescription();
    await fetchAndUpdateConcentrateRatings();
  });

  async function fetchAndUpdatConcentrateDescription() {
    var cultivator = "{{ cultivator }}";
    var strain = "{{ strain }}";
    var endpoint = "/concentrate_reviews/get_concentrate_description?&strain=" + encodeURIComponent(strain) + "&cultivator=" + encodeURIComponent(cultivator);

    fetch(endpoint)
    .then(response => response.json())
    .then(data => {
        if (!data.error) {
            let terpenesList = data.terpenes_list
            if (terpenesList && terpenesList.length > 0) {
              const dataValues = terpenesList.map(() => 1);
              initTerpeneChart(terpenesList, dataValues);
            }
        } else {
            console.error('Error fetching data:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
  }

  async function fetchAndUpdateConcentrateRatings() {
    const concentrateId = "{{ concentrate_id }}";
    const endpoint = "/concentrate_ranking/get_concentrate_ratings_by_id/" + concentrateId;
  
    try {
      const response = await fetch(endpoint);
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const ratingsData = await response.json();
      
      if (!ratingsData.error) {
          const formatRating = (rating) => {
            return rating !== null ? parseFloat(rating).toFixed(2) : '?';
          };
          document.getElementById('flavor_rating_value').textContent = formatRating(ratingsData.flavor_rating);
          document.getElementById('overall_rating_value').textContent = formatRating(ratingsData.overall_score);
          document.getElementById('effects_rating_value').textContent = formatRating(ratingsData.effects_rating);
          document.getElementById('harshness_rating_value').textContent = formatRating(ratingsData.harshness_rating);
          document.getElementById('color_rating_value').textContent = formatRating(ratingsData.color_rating);
          document.getElementById('smell_rating_value').textContent = formatRating(ratingsData.smell_rating);
          document.getElementById('consistency_rating_value').textContent = formatRating(ratingsData.consistency_rating);
        } else {
          console.error('Error fetching data:', ratingsData.error);
        }
      } catch (error) {
        console.error('Error:', error);
      }
  }

  function initTerpeneChart(labels, dataValues) {
    const ctx = document.getElementById('terpeneChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: 'Terpenes',
          data: dataValues,
          backgroundColor: generateColors(labels.length),
        }]
      }
    });
  }
  function generateColors(count) {
    const colors = [
      'rgba(63, 81, 181, 0.5)', 'rgba(77, 182, 172, 0.5)', 'rgba(66, 133, 244, 0.5)',
      'rgba(156, 39, 176, 0.5)', 'rgba(233, 30, 99, 0.5)', 'rgba(66, 73, 244, 0.4)',
      'rgba(66, 133, 244, 0.2)'
    ];
    return colors.slice(0, count);
  }
</script>
<script>
  async function fetchFlowerData() {
    try {
      const response = await fetch('/flower_voting/get_top_rated_flower_strains');
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const flowerData = await response.json();

      updateFlowerData(flowerData);
    } catch (error) {
      console.error('Error fetching flower data:', error);
    }
  }
</script>
{% endblock %}

{% block footer %}
{% endblock %}

{% block scripts %}
{% endblock %}
