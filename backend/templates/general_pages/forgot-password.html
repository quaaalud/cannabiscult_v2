{% extends "shared/base.html" %}

{% block title %} 
  <title>Cannabis Cult - Forgot Password</title>
{% endblock %} 

{% block head %}
<meta 
  property="og:image" 
  content="{{ url_for('static', path='images/black_cc_logo.png') }}"
  alt="Cannabis Cult Main Logo with Brain"
/>
<meta 
  content="The Cannbis Cult and it's members are connecting every aspect of the Cannabis supply chain, from Cultivators to Consumers, creating a network of the best available products and practices." 
  name="description"
/>
<meta 
  property="og:description" 
  content="The Cannbis Cult and it's members are connecting every aspect of the Cannabis supply chain, from Cultivators to Consumers, creating a network of the best available products and practices."
/>
<meta 
  property="og:title" 
  content="The Cannabis Cult - Forgot Password"
/>
<meta 
  name="twitter:card" 
  content="summary_large_image"
/>
<meta 
  property="twitter:url" 
  content="https://cannabiscult.co"
/>
<meta 
  property="twitter:title" 
  content="The Cannabis Cult - Forgot Password"
/>
<meta 
  property="twitter:description" 
  content="The Cannbis Cult and it's members are connecting every aspect of the Cannabis supply chain, from Cultivators to Consumers, creating a network of the best available products and practices."
/>
<meta 
  name="twitter:site" 
  content="https://cannabiscult.co/"
/>
<meta 
  property="twitter:image" 
  content="{{ url_for('static', path='images/black_cc_logo.png') }}"
  alt="Cannabis Cult Main Logo with Brain"
/>
{% endblock %}

{% block header %}
{% endblock %}

{% block content %} 
<main>
  <div class="text-center">
    <div class="container-fluid text-center" style="padding:2em">
      <img src="{{ url_for('static', path='images/small_black_cc_logo.png') }}">
    </div>
  </div>
  <div class="text-center">
    <div class="container-fluid text-center" style="padding:2em">
      <section class="container">
        <div class="card">
          <div class="card-header">
            <div class="container pb-3">
              <div class="row text-start justify-content-center">
                <div class="col-sm-12 col-md-9 col-lg-7 col-xl-6">
                  <div class="card-body">
                    <div class="container pb-3">
                      <div class="row text-start justify-content-center">
                        <div class="col-md-12 col-lg-9">
                          <form method="POST" action="/submit-new-password" id="new-pasword-form" name="new-pasword-form">
                            <div class="text-center mb-3">
                              <h4><u>Set New Password</u></h4>
                            </div>
                            <!-- Email input -->
                            <div class="form-outline mb-4">
                              <input name="user_email" type="email" id="user_email" class="form-control" />
                              <label class="form-label" for="user_email">Email</label>
                            </div>
                            <div class="form-outline mb-4">
                              <input type="text" id="username" name="username" class="form-control" />
                              <label class="form-label" for="current_password">Username</label>
                            </div>
                            <!-- Password input -->
                            <div class="form-outline mb-4">
                              <input type="password" id="new_password" name="new_password" class="form-control" />
                              <label class="form-label" for="new_password">New Password</label>
                            </div>
                            <div class="form-outline mb-4">
                              <input type="password" id="repeated_password" name="repeated_password" class="form-control" />
                              <label class="form-label" for="repeated_password">Repeat Password</label>
                            </div>
                            <!-- 2 column grid layout -->
                            <div class="row align-content-center justify-content-center text-center d-flex mb-4">
                              <!-- Simple link -->
                              <div class="col-12">
                                <button id="reset-password-button" name="new-password-submit" type="button" class="btn btn-primary btn-block mb-4">Reset Password</button>
                              </div>
                              <div class="col-sm-12 col-md-6 p-1 ps-3 pe-3">
                                <a class="btn btn-secondary w-100 mb-3" href="/login">Login</a>
                              </div>
                              <div class="col-sm-12 col-md-6 p-1 pe-3 ps-3">
                                <a class="btn btn-primary w-100 mb-3" href="/login">Register</a>
                              </div>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                    <div class="row justify-content-center align-content-center text-center mt-1">
                      <div class="col-10">
                        <h6>We know it happens sometimes. If you have forgetten the Username and Email used to create your account, <a href="mailto:contact@thesocialoutfitus.com">send us an email</a> and a Cult Leader will follow up to reset your account.</h6>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>  
    </div>
  </div>
  <script>
    async function updatePassword() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (!token) {
          console.error("Token is missing. Cannot reset password.");
          return;
        }
        
        const email = document.getElementById("user_email").value;
        const username = document.getElementById("username").value;
        const newPassword = document.getElementById("new_password").value;
        const repeatedPassword = document.getElementById("repeated_password").value;
        
        if (newPassword !== repeatedPassword) {
          console.error("Passwords do not match");
          // Handle this case as appropriate for your application
          return;
        }
    
        try {
          const { data, error } = await window.supabase.auth.api.updateUser(token, {
            password: newPassword
          });
          
          if (error) {
            console.error("Error updating password:", error);
            // Handle error as appropriate for your application
          } else {
            console.log("Password updated successfully:", data);
            // Perform any follow-up actions, e.g., redirect to login
          }
        }       
        catch (e) {
          console.error("An unexpected error occurred:", e);
          // Handle unexpected errors
        }
      }
      // Add an event listener to call updatePassword when the "Reset Password" button is clicked
      document.getElementById("reset-password-button").addEventListener("click", updatePassword);
    </script>
</main>
{% endblock %}  

{% block footer %}
{% endblock %}


{% block scripts %}  
{% endblock %}
