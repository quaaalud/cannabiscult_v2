{% extends "shared/base.html" %}

{% block title %}
    <title>GLB Model Test Page</title>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">3D GLB Model Test Viewer</h1>
    <!-- Dropzone for GLB file -->
    <div id="dropZone" class="bg-light text-center border border-primary py-5 my-4">
        <p>Drag and drop a .glb file here or click to upload</p>
    </div>
    <!-- Canvas for rendering 3D model -->
    <canvas id="modelCanvas" class="w-100 border" style="height: 600px;"></canvas>
</div>
{% endblock %}

{% block scripts %}
<!-- Import map to load specific modules from CDN -->
<script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/"
        }
    }
</script>

<!-- Main Script to handle GLB model loading -->
<script type="module">
    import * as THREE from "{{ url_for('static', path='js/three/three.module.js') }}";
    import { GLTFLoader } from "{{ url_for('static', path='js/three/GLTFLoader.js') }}";

    document.addEventListener('DOMContentLoaded', function () {
        const dropZone = document.getElementById('dropZone');
        const canvas = document.getElementById('modelCanvas');
        let renderer, scene, camera;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);

        // Handle click event to trigger file input
        dropZone.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.glb';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file.name.endsWith('.glb')) {
                    loadGLBFile(file);
                } else {
                    alert('Please upload a valid .glb file.');
                }
            };
            input.click();
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.glb')) {
                    loadGLBFile(file);
                } else {
                    alert('Please upload a valid .glb file.');
                }
            }
        }

        function loadGLBFile(file) {
            const reader = new FileReader();

            reader.onload = function (event) {
                const arrayBuffer = event.target.result;
                const blob = new Blob([arrayBuffer], { type: 'model/gltf-binary' });
                const url = URL.createObjectURL(blob);

                // Initialize Three.js and load the model
                initThreeJS(url);
            };

            reader.readAsArrayBuffer(file);
        }

        function initThreeJS(modelURL) {
            // Initialize renderer, scene, and camera if not already set
            if (!renderer) {
                renderer = new THREE.WebGLRenderer({ canvas: canvas });
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);

                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
                camera.position.z = 5;

                // Add lighting
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(1, 1, 1).normalize();
                scene.add(light);
            }

            // Clear previous models from the scene
            while (scene.children.length > 0) {
                scene.remove(scene.children[0]);
            }

            // Load the GLB model using GLTFLoader
            const loader = new GLTFLoader();
            loader.load(modelURL, function (gltf) {
                scene.add(gltf.scene);
                animate();
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
    });
</script>
{% endblock %}
